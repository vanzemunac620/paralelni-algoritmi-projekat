name: Check student info
on: [push, pull_request]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate info.yml
        run: |
          FILE="info.yml"

          if ! test -f "$FILE"; then
            echo "❌ info.yml is missing."
            exit 1
          fi

          ###############################################
          # 1. Extract main fields
          ###############################################
          MAIN_STUDENT=$(grep "^student:" "$FILE" | sed 's/student: *//; s/"//g')
          MAIN_INDEX=$(grep "^indeks:" "$FILE" | sed 's/indeks: *//; s/"//g')

          ###############################################
          # 2. Main student must not be empty
          ###############################################
          if [ -z "$MAIN_STUDENT" ]; then
            echo "❌ 'student' field must not be empty."
            exit 1
          fi

          ###############################################
          # 3. Validate main indeks format
          # Allowed: RN|SI|RI ###/####
          ###############################################
          if ! echo "$MAIN_INDEX" | grep -Eq "^(RN|SI|RI) [0-9]{3}/[0-9]{4}$"; then
            echo "❌ indeks must match format: RN|SI|RI ###/#### (e.g., RN 123/2025)."
            exit 1
          fi

          ###############################################
          # 4. Extract partner fields
          ###############################################
          PAR_STUDENT=$(grep "par:" -A2 "$FILE" | grep "student:" | sed 's/student: *//; s/"//g')
          PAR_INDEX=$(grep "par:" -A2 "$FILE" | grep "indeks:"  | sed 's/indeks: *//;  s/"//g')

          ###############################################
          # 5. Partner logic:
          # Case A: both fields empty → OK
          # Case B: both fields non-empty AND valid index → OK
          # Otherwise → fail
          ###############################################

          # Case A: both empty (working alone)
          if [ -z "$PAR_STUDENT" ] && [ -z "$PAR_INDEX" ]; then
            echo "✔ Working alone — par is empty."
            exit 0
          fi

          # If only one field is empty → fail
          if [ -z "$PAR_STUDENT" ] || [ -z "$PAR_INDEX" ]; then
            echo "❌ If partner is included, both student and indeks must be filled."
            exit 1
          fi

          # Validate partner index
          if ! echo "$PAR_INDEX" | grep -Eq "^(RN|SI|RI) [0-9]{3}/[0-9]{4}$"; then
            echo "❌ par.indeks must match format: RN|SI|RI ###/####"
            exit 1
          fi

          echo "✔ info.yml looks OK"
